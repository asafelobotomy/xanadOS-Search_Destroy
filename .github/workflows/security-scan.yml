name: Enhanced Security Scanning

on:
    push:
        branches: [master, develop]
    pull_request:
        branches: [master]
    schedule:
        # Run security scans weekly (Sundays at 2 AM UTC)
        - cron: "0 2 * * 0"

permissions:
    contents: read
    security-events: write
    actions: read

jobs:
    # Job 1: Bandit security linter for Python
    bandit:
        name: Bandit Security Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Install Bandit
              run: |
                  python -m pip install --upgrade pip
                  pip install bandit[toml]

            - name: Run Bandit scan
              run: |
                  bandit -r app/ scripts/ -f json -o bandit-report.json
                  bandit -r app/ scripts/ -f txt
              continue-on-error: true

            - name: Upload Bandit results
              uses: actions/upload-artifact@v4
              with:
                  name: bandit-results
                  path: bandit-report.json

    # Job 2: Safety dependency vulnerability scanner
    safety:
        name: Safety Dependency Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Install uv
              run: |
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  echo "$HOME/.cargo/bin" >> $GITHUB_PATH

            - name: Install dependencies
              run: |
                  uv sync --all-extras

            - name: Install Safety
              run: |
                  pip install safety

            - name: Run Safety check
              run: |
                  # Generate requirements.txt for Safety
                  uv pip freeze > requirements-frozen.txt

                  # Run Safety scan (updated output format for Safety v3+)
                  safety check --file requirements-frozen.txt --output json > safety-report.json || true
                  safety check --file requirements-frozen.txt
              continue-on-error: true

            - name: Upload Safety results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: safety-results
                  path: safety-report.json

    # Job 3: Trivy vulnerability scanner
    trivy:
        name: Trivy Security Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy results to GitHub Security tab
              uses: github/codeql-action/upload-sarif@v4
              with:
                  sarif_file: "trivy-results.sarif"

    # Job 4: CodeQL semantic analysis
    codeql:
        name: CodeQL Analysis
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                language: ["python"]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Initialize CodeQL
              uses: github/codeql-action/init@v4
              with:
                  languages: ${{ matrix.language }}
                  queries: +security-extended,security-and-quality

            - name: Autobuild
              uses: github/codeql-action/autobuild@v4

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v4
              with:
                  category: "/language:${{ matrix.language }}"

    # Job 5: Semgrep static analysis
    semgrep:
        name: Semgrep Security Scan
        runs-on: ubuntu-latest

        container:
            image: semgrep/semgrep

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run Semgrep
              run: |
                  semgrep scan --config=auto --json --output=semgrep-results.json .
                  semgrep scan --config=auto .
              continue-on-error: true

            - name: Upload Semgrep results
              uses: actions/upload-artifact@v4
              with:
                  name: semgrep-results
                  path: semgrep-results.json

    # Job 6: Secret scanning with Gitleaks
    gitleaks:
        name: Gitleaks Secret Scan
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Run Gitleaks
              uses: gitleaks/gitleaks-action@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

    # Job 7: Security summary and reporting
    security-summary:
        name: Security Summary
        runs-on: ubuntu-latest
        needs: [bandit, safety, trivy, codeql, semgrep, gitleaks]
        if: always()

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4

            - name: Generate security summary
              run: |
                  echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Bandit | ${{ needs.bandit.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Safety | ${{ needs.safety.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Trivy | ${{ needs.trivy.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| CodeQL | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Semgrep | ${{ needs.semgrep.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Gitleaks | ${{ needs.gitleaks.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Scan completed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
