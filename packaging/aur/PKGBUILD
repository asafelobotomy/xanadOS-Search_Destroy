# Maintainer: xanadOS Team <dev@xanados.org>
# Contributor: xanadOS Team <dev@xanados.org>

pkgname=xanados-search-destroy
pkgver=0.3.0
pkgrel=1
pkgdesc='Comprehensive Linux security scanner and system protection suite'
arch=('any')
url='https://github.com/asafelobotomy/xanadOS-Search_Destroy'
license=('GPL-3.0-or-later')
depends=(
    'python>=3.13'
    'python-pyqt6>=6.9.1'
    'python-requests>=2.32.0'
    'python-psutil>=6.1.0'
    'python-cryptography>=44.0.0'
    'python-yaml>=6.0.2'
    'python-click>=8.1.7'
    'python-rich>=13.9.4'
    'python-colorama>=0.4.6'
    'python-tabulate>=0.9.0'
    'python-numpy>=2.2.0'
    'python-schedule>=1.2.2'
    'python-aiohttp>=3.11.0'
    'python-watchdog>=6.0.0'
    'python-dnspython>=2.8.0'
    'python-dotenv>=1.0.1'
    'clamav'
    'rkhunter>=1.4.6'
    'inotify-tools'
    'sudo'
    'polkit'
)
makedepends=(
    'python-build'
    'python-installer'
    'python-wheel'
    'python-setuptools'
    'git'
)
optdepends=(
    'chkrootkit: Additional rootkit detection'
    'lynis: Security auditing tool'
    'aide: File integrity checker'
    'python-yara: YARA rule engine for malware detection'
    'python-fastapi: REST API support'
    'python-uvicorn: ASGI server for API'
)
backup=(
    'etc/xanados-search-destroy/security_config.toml'
    'etc/xanados-search-destroy/monitoring_config.toml'
    'etc/xanados-search-destroy/gui_config.toml'
)
source=(
    "${pkgname}-${pkgver}.tar.gz::https://github.com/asafelobotomy/xanadOS-Search_Destroy/archive/v${pkgver}.tar.gz"
)
sha256sums=('SKIP')  # Update with actual checksum for releases

prepare() {
    cd "${srcdir}/xanadOS-Search_Destroy-${pkgver}"
    
    # Ensure we have the VERSION file
    echo "${pkgver}" > VERSION
}

build() {
    cd "${srcdir}/xanadOS-Search_Destroy-${pkgver}"
    
    # Build Python package
    python -m build --wheel --no-isolation
}

check() {
    cd "${srcdir}/xanadOS-Search_Destroy-${pkgver}"
    
    # Basic import test
    python -c "import sys; sys.path.insert(0, 'app'); import app; print('Version:', app.__version__)"
}

package() {
    cd "${srcdir}/xanadOS-Search_Destroy-${pkgver}"
    
    # Install Python package
    python -m installer --destdir="${pkgdir}" dist/*.whl
    
    # Install desktop file
    install -Dm644 "packaging/desktop/io.github.asafelobotomy.SearchAndDestroy.desktop" \
        "${pkgdir}/usr/share/applications/io.github.asafelobotomy.SearchAndDestroy.desktop"
    
    # Install icons
    for size in 16 32 48 64 128; do
        install -Dm644 "packaging/icons/io.github.asafelobotomy.SearchAndDestroy-${size}.png" \
            "${pkgdir}/usr/share/icons/hicolor/${size}x${size}/apps/io.github.asafelobotomy.SearchAndDestroy.png"
    done
    
    # Install SVG icon
    install -Dm644 "packaging/icons/io.github.asafelobotomy.SearchAndDestroy.svg" \
        "${pkgdir}/usr/share/icons/hicolor/scalable/apps/io.github.asafelobotomy.SearchAndDestroy.svg"
    
    # Install AppStream metadata
    install -Dm644 "packaging/appdata/io.github.asafelobotomy.SearchAndDestroy.metainfo.xml" \
        "${pkgdir}/usr/share/metainfo/io.github.asafelobotomy.SearchAndDestroy.metainfo.xml"
    
    # Install polkit policy
    install -Dm644 "config/io.github.asafelobotomy.searchanddestroy.policy" \
        "${pkgdir}/usr/share/polkit-1/actions/io.github.asafelobotomy.searchanddestroy.policy"
    
    # Install configuration files
    install -Dm644 "config/security_config.toml" \
        "${pkgdir}/etc/xanados-search-destroy/security_config.toml"
    install -Dm644 "config/monitoring_config.toml" \
        "${pkgdir}/etc/xanados-search-destroy/monitoring_config.toml"
    install -Dm644 "config/gui_config.toml" \
        "${pkgdir}/etc/xanados-search-destroy/gui_config.toml"
    
    # Install YARA rules
    install -Dm644 "config/yara_rules/malware_detection.yar" \
        "${pkgdir}/usr/share/xanados-search-destroy/yara_rules/malware_detection.yar"
    
    # Install systemd service
    install -Dm644 "packaging/systemd/xanados-search-destroy-monitor.service" \
        "${pkgdir}/usr/lib/systemd/system/xanados-search-destroy-monitor.service"
    
    # Install documentation
    install -Dm644 README.md "${pkgdir}/usr/share/doc/${pkgname}/README.md"
    install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
    install -Dm644 CHANGELOG.md "${pkgdir}/usr/share/doc/${pkgname}/CHANGELOG.md"
    
    # Create runtime directories
    install -dm755 "${pkgdir}/var/lib/xanados-search-destroy"
    install -dm700 "${pkgdir}/var/lib/xanados-search-destroy/quarantine"
    install -dm755 "${pkgdir}/var/log/xanados-search-destroy"
}

post_install() {
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "✅ xanadOS Search & Destroy installed successfully!"
    echo ""
    echo "Quick Start:"
    echo "  1. Update ClamAV definitions: sudo freshclam"
    echo "  2. Launch application: xanados-search-destroy"
    echo "  3. Or from menu: Applications → Security → Search & Destroy"
    echo ""
    echo "For real-time protection:"
    echo "  sudo systemctl enable --now xanados-search-destroy-monitor"
    echo ""
    echo "Documentation: /usr/share/doc/xanados-search-destroy/"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

post_upgrade() {
    post_install
}

post_remove() {
    echo ""
    echo "xanadOS Search & Destroy has been removed."
    echo ""
    echo "Note: Configuration files in /etc/xanados-search-destroy/"
    echo "and data in /var/lib/xanados-search-destroy/ have been preserved."
    echo "Remove them manually if desired."
    echo ""
}
