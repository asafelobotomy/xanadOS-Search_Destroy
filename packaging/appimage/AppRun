#!/bin/bash
# AppRun launcher for xanadOS Search & Destroy AppImage
# This script is executed when the AppImage is run

# Get the directory where the AppImage is mounted
APPDIR="$(dirname "$(readlink -f "$0")")"

# Set up environment variables for the bundled Python
PYTHON_VERSION=$(ls "$APPDIR/usr/lib" | grep "^python3\." | head -1)

# Set PYTHONHOME to point to the bundled Python location
export PYTHONHOME="$APPDIR/usr"

# Build PYTHONPATH with all necessary directories
export PYTHONPATH="$APPDIR/usr/lib/$PYTHON_VERSION"
export PYTHONPATH="$PYTHONPATH:$APPDIR/usr/lib/$PYTHON_VERSION/lib-dynload"
export PYTHONPATH="$PYTHONPATH:$APPDIR/usr/lib/$PYTHON_VERSION/site-packages"

# Set library path for bundled Python
export LD_LIBRARY_PATH="$APPDIR/usr/lib:${LD_LIBRARY_PATH}"

# Set PATH to use bundled Python
export PATH="$APPDIR/usr/bin:$PATH"

# SSL certificates
if [ -f "$APPDIR/usr/lib/$PYTHON_VERSION/site-packages/certifi/cacert.pem" ]; then
    export SSL_CERT_FILE="$APPDIR/usr/lib/$PYTHON_VERSION/site-packages/certifi/cacert.pem"
fi

# Set Qt platform plugin path
export QT_PLUGIN_PATH="$APPDIR/usr/lib/qt6/plugins"
export QT_QPA_PLATFORM_PLUGIN_PATH="$APPDIR/usr/lib/qt6/plugins/platforms"

# XDG directories for config and data
export XDG_DATA_DIRS="$APPDIR/usr/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"
export XDG_CONFIG_DIRS="$APPDIR/usr/etc/xdg:${XDG_CONFIG_DIRS:-/etc/xdg}"

# Suppress Wayland warnings if running on Wayland
if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
export QT_WAYLAND_DISABLE_WINDOWDECORATION=1
fi

# PolicyKit policy installation check
POLICY_DIR="/usr/share/polkit-1/actions"
POLICY_FILES=(
"io.github.asafelobotomy.searchanddestroy.policy"
"io.github.asafelobotomy.searchanddestroy.hardened.policy"
"io.github.asafelobotomy.searchanddestroy.rkhunter.policy"
)

# Check if PolicyKit policies are installed (needed for sudo operations)
POLICIES_MISSING=false
for policy in "${POLICY_FILES[@]}"; do
if [ ! -f "$POLICY_DIR/$policy" ]; then
POLICIES_MISSING=true
break
fi
done

# If policies are missing, offer to install them (one-time setup)
if [ "$POLICIES_MISSING" = true ] && [ "$1" != "--skip-policy-check" ]; then
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  xanadOS Search & Destroy - First Run Setup"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "This application requires PolicyKit policies for privileged operations"
echo "(ClamAV installation, RKhunter scans, quarantine management)."
echo ""
echo "Would you like to install PolicyKit policies now? (requires sudo)"
echo ""
read -p "Install policies? [Y/n]: " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
echo "Installing PolicyKit policies..."
for policy in "${POLICY_FILES[@]}"; do
if [ -f "$APPDIR/usr/share/polkit-1/actions/$policy" ]; then
sudo cp "$APPDIR/usr/share/polkit-1/actions/$policy" "$POLICY_DIR/" && \
  echo "✓ Installed $policy"
fi
done
echo ""
echo "✓ PolicyKit policies installed successfully!"
echo "  You can now use all features of xanadOS Search & Destroy."
echo ""
else
echo ""
echo "⚠ Skipping policy installation."
echo "  Note: Some features requiring elevated privileges will not work."
echo "  Run the AppImage again to install policies later."
echo ""
fi
fi

# Change to the app directory
cd "$APPDIR/usr/app" || exit 1

# Execute the Python application with all arguments passed to AppImage
exec "$APPDIR/usr/bin/python3" -m app.main "$@"
