/*
    YARA Rules for xanadOS Search & Destroy

    Heuristic and behavioral malware detection rules
    Complements ClamAV signature-based detection
*/

rule Suspicious_ELF_Binary {
    meta:
        description = "Detects suspicious ELF binaries with potential malware characteristics"
        author = "xanadOS Security"
        severity = "medium"

    strings:
        $elf_magic = { 7F 45 4C 46 }
        $execve = "execve"
        $system = "system"
        $chmod = "chmod"
        $rm_rf = "rm -rf"
        $suspicious_path1 = "/tmp/."
        $suspicious_path2 = "/dev/shm/"

    condition:
        $elf_magic at 0 and
        (
            (2 of ($execve, $system, $chmod, $rm_rf)) or
            (1 of ($suspicious_path*) and 1 of ($execve, $system)) or
            ($rm_rf and ($execve or $system))
        )
}

rule Suspicious_Script {
    meta:
        description = "Detects suspicious shell scripts with malware-like behavior"
        author = "xanadOS Security"
        severity = "high"

    strings:
        $shebang1 = "#!/bin/bash"
        $shebang2 = "#!/bin/sh"
        $shebang3 = "#!/usr/bin/env bash"

        $wget = "wget"
        $curl = "curl"
        $base64 = "base64"
        $eval = "eval"
        $chmod_x = "chmod +x"
        $rm_rf = "rm -rf"
        $dev_null = "/dev/null"
        $cron = "cron"

        $suspicious_url = /http[s]?:\/\/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/

    condition:
        any of ($shebang*) and
        (
            (($wget or $curl) and $eval) or
            (($wget or $curl) and $chmod_x and $dev_null) or
            ($suspicious_url and 2 of ($wget, $curl, $base64, $eval)) or
            ($cron and ($wget or $curl)) or
            ($rm_rf and ($wget or $curl or $eval))
        )
}

rule Python_Reverse_Shell {
    meta:
        description = "Detects Python reverse shell patterns"
        author = "xanadOS Security"
        severity = "high"

    strings:
        $python = "python"
        $socket = "socket"
        $subprocess = "subprocess"
        $connect = "connect"
        $dup2 = "dup2"
        $shell = "/bin/sh"
        $bash = "/bin/bash"

    condition:
        $python and $socket and $subprocess and
        (
            ($connect and $dup2) or
            ($connect and ($shell or $bash))
        )
}

rule Hidden_Payload {
    meta:
        description = "Detects files with embedded or hidden payloads"
        author = "xanadOS Security"
        severity = "medium"

    strings:
        $pdf_magic = { 25 50 44 46 }
        $jpg_magic = { FF D8 FF }
        $png_magic = { 89 50 4E 47 }

        $elf_magic = { 7F 45 4C 46 }
        $pe_magic = "MZ"

    condition:
        (
            ($pdf_magic at 0 or $jpg_magic at 0 or $png_magic at 0) and
            ($elf_magic or $pe_magic)
        )
}

rule Crypto_Miner {
    meta:
        description = "Detects cryptocurrency mining software"
        author = "xanadOS Security"
        severity = "medium"

    strings:
        $xmrig = "xmrig" nocase
        $monero = "monero" nocase
        $stratum = "stratum+tcp"
        $mining_pool1 = "pool.minexmr"
        $mining_pool2 = "pool.supportxmr"
        $mining_pool3 = "xmrpool.eu"
        $donate_level = "donate-level"
        $hashrate = "hashrate"

    condition:
        (
            $xmrig or
            ($monero and ($stratum or $donate_level)) or
            (2 of ($mining_pool*)) or
            ($stratum and $hashrate)
        )
}

rule Ransomware_Behavior {
    meta:
        description = "Detects ransomware-like file encryption behavior"
        author = "xanadOS Security"
        severity = "critical"

    strings:
        $crypt1 = "encrypt" nocase
        $crypt2 = "decrypt" nocase
        $ransom1 = "ransom" nocase
        $ransom2 = "bitcoin" nocase
        $ransom3 = "payment"
        $file_ext1 = ".locked"
        $file_ext2 = ".encrypted"
        $file_ext3 = ".crypto"
        $readme = "README" nocase

    condition:
        (
            ($crypt1 and $crypt2 and ($ransom1 or $ransom2)) or
            (2 of ($file_ext*) and ($ransom2 or $ransom3)) or
            ($crypt1 and $readme and $ransom2)
        )
}

rule Keylogger_Pattern {
    meta:
        description = "Detects keylogger-like patterns"
        author = "xanadOS Security"
        severity = "high"

    strings:
        $xdo = "xdotool"
        $xinput = "xinput"
        $evdev = "/dev/input/event"
        $keylog = "keylog" nocase
        $keystroke = "keystroke" nocase
        $keypress = "keypress" nocase

    condition:
        (
            ($xdo or $xinput or $evdev) and
            ($keylog or $keystroke or $keypress)
        )
}

rule Suspicious_Network_Activity {
    meta:
        description = "Detects suspicious network communication patterns"
        author = "xanadOS Security"
        severity = "medium"

    strings:
        $nc = "nc" fullword
        $netcat = "netcat"
        $socat = "socat"
        $telnet = "telnet"
        $reverse_shell = "-e /bin/sh"
        $bind_shell = "-l -p"
        $exec_shell = "-e /bin/bash"

    condition:
        (
            (($nc or $netcat or $socat or $telnet) and ($reverse_shell or $exec_shell)) or
            ($nc and $bind_shell)
        )
}

rule Webshell_PHP {
    meta:
        description = "Detects PHP webshell patterns"
        author = "xanadOS Security"
        severity = "high"

    strings:
        $php = "<?php"
        $eval = "eval"
        $base64_decode = "base64_decode"
        $system = "system"
        $exec = "exec"
        $shell_exec = "shell_exec"
        $passthru = "passthru"
        $request = /\$_(GET|POST|REQUEST|COOKIE)/

    condition:
        $php and
        (
            ($eval and $base64_decode) or
            ($request and 2 of ($system, $exec, $shell_exec, $passthru)) or
            ($eval and $request)
        )
}

rule Obfuscated_Code {
    meta:
        description = "Detects heavily obfuscated code (common in malware)"
        author = "xanadOS Security"
        severity = "low"

    strings:
        $base64_long = /[A-Za-z0-9+\/]{200,}/
        $hex_long = /\\x[0-9a-fA-F]{2}/
        $eval = "eval"
        $exec = "exec"

    condition:
        (
            (#base64_long > 3 and ($eval or $exec)) or
            (#hex_long > 50)
        )
}
