app-id: io.github.asafelobotomy.SearchAndDestroy
runtime: org.freedesktop.Platform
runtime-version: "23.08"
sdk: org.freedesktop.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: "6.8"
command: search-and-destroy
cleanup-commands:
  - /app/cleanup-BaseApp.sh
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable

finish-args:
  # GUI access
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland

  # File access via portals only (no broad filesystem access)
  - --filesystem=xdg-run/app/org.freedesktop.portal.Documents:create

  # Network access for virus definition updates
  - --share=network

  # System integration (notifications)
  - --talk-name=org.freedesktop.Notifications

modules:
  - name: json-c
    buildsystem: cmake-ninja
    config-opts:
      - '-DCMAKE_BUILD_TYPE=RelWithDebInfo'
    sources:
      - type: git
        url: https://github.com/json-c/json-c.git
        tag: json-c-0.18-20240915
        commit: 41a55cfcedb54d9c1874f2f0eb07b504091d7e37
    cleanup:
      - '/include'
      - '/lib/cmake'
      - '/lib/pkgconfig'
      - '*.a'

  - name: clamav
    buildsystem: cmake-ninja
    build-options:
      append-path: '/usr/lib/sdk/rust-stable/bin'
      env:
        CARGO_HOME: '/run/build/clamav/cargo'
        RUSTUP_HOME: '/run/build/clamav/rustup'
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DENABLE_STATIC_LIB=OFF
      - -DENABLE_SHARED_LIB=ON
      - -DENABLE_SYSTEMD=OFF
      - -DCMAKE_INSTALL_PREFIX=/app
      - -DENABLE_CLAMONACC=OFF
      - -DENABLE_MILTER=OFF
      - -DENABLE_UNRAR=OFF
      - -DENABLE_APP=ON
      - -DENABLE_DOXYGEN=OFF
      - -DENABLE_EXAMPLES=OFF
      - -DENABLE_MAN_PAGES=OFF
      - -DENABLE_TESTS=OFF
    sources:
      - type: archive
        url: https://github.com/Cisco-Talos/clamav/releases/download/clamav-1.4.3/clamav-1.4.3.tar.gz
        sha256: d874cabf3d4765b35b518ef535658a1e6ec74802006a1d613f9f124aa1343210
      # Bundle pre-fetched ClamAV database files from the repository, if present
      # Drop files like main.cvd, daily.cvd, bytecode.cvd into
      # packaging/flatpak/clamav-db/ before building. Checksums are tracked by git.
      - type: dir
        path: clamav-db
        dest: clamav-db
    post-install:
      # Optional: place pre-fetched database files under /app/share/clamav
      - install -d /app/share/clamav
      - |
          if [ -d "clamav-db" ] && ls clamav-db/* >/dev/null 2>&1; then
            install -Dm644 clamav-db/* /app/share/clamav/
          fi

  - name: python-dependencies
    buildsystem: simple
    build-options:
      env:
        PIP_DISABLE_PIP_VERSION_CHECK: '1'
        PIP_NO_CACHE_DIR: '1'
    build-commands:
      - pip3 install --verbose --exists-action=i --no-build-isolation --find-links="file://${PWD}/packaging/flatpak/vendor" --prefix=${FLATPAK_DEST} -r packaging/flatpak/requirements-base.txt
    sources:
      - type: dir
        path: ../..

  - name: search-and-destroy
    buildsystem: simple
    build-commands:
      - install -Dm755 packaging/flatpak/search-and-destroy.sh /app/bin/search-and-destroy
      - cp -r app/ /app/lib/search-and-destroy/
      - install -Dm644 packaging/flatpak/io.github.asafelobotomy.SearchAndDestroy.desktop /app/share/applications/io.github.asafelobotomy.SearchAndDestroy.desktop
      - install -Dm644 packaging/flatpak/io.github.asafelobotomy.SearchAndDestroy.metainfo.xml /app/share/metainfo/io.github.asafelobotomy.SearchAndDestroy.metainfo.xml
      # Install icons
      - install -Dm644 packaging/icons/io.github.asafelobotomy.SearchAndDestroy.svg /app/share/icons/hicolor/scalable/apps/io.github.asafelobotomy.SearchAndDestroy.svg
      - |
          for size in 16 32 48 64 128; do
            if [ -f "packaging/icons/io.github.asafelobotomy.SearchAndDestroy-${size}.png" ]; then
              install -Dm644 "packaging/icons/io.github.asafelobotomy.SearchAndDestroy-${size}.png" "/app/share/icons/hicolor/${size}x${size}/apps/io.github.asafelobotomy.SearchAndDestroy.png"
            fi
          done
      # Ship default configuration and build metadata
      - install -d /app/share/search-and-destroy/config
      - cp -r config/*.toml /app/share/search-and-destroy/config/ 2>/dev/null || true
      - cp -r config/*.json /app/share/search-and-destroy/config/ 2>/dev/null || true
      - if [ -f VERSION ]; then install -Dm644 VERSION /app/share/search-and-destroy/VERSION; fi
    sources:
      - type: dir
        path: ../..
